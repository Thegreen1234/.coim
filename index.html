<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="pageTitle">永續商店地圖 - 首頁</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f7f4;
        }
        .hero-section {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .tag {
            background-color: #dcfce7;
            color: #16a34a;
        }
        .tag.active {
            background-color: #16a34a;
            color: white;
        }
        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }
        .shop-card {
            transition: all 0.3s ease;
            display: flex; /* 將卡片本身設為 flex 容器 */
            flex-direction: column; /* 讓子元素垂直堆疊 */
        }
        .shop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        /* 讓卡片內容區塊填滿可用空間，並將按鈕推到底部 */
        .shop-card > div.p-6 {
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 將第一個元素 (商店資訊) 向上推，最後一個元素 (按鈕) 向下推 */
            flex-grow: 1; /* 允許這個區域成長以填滿卡片剩餘空間 */
        }
        /* 確保按鈕在 flex 容器中自動推到底部 */
        .shop-card button {
            margin-top: auto; /* 這個屬性在 flex 容器中會將元素推到末端 */
        }
        .shop-detail-header {
            background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('https://images.unsplash.com/photo-1551488831-00ddcb6c6bd3?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80');
            background-size: cover;
            background-position: center;
        }
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 比例 */
            height: 0;
            overflow: hidden;
            max-width: 100%;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        /* 確保地圖容器有正確的z-index和定位 */
        .map-container {
            position: relative;
            z-index: 10; /* 確保地圖不會超出其容器 */
            overflow: hidden;
        }
        /* 修正地圖控制項的z-index */
        .leaflet-control-container {
            z-index: 10;
        }
        /* 確保彈出視窗的z-index高於地圖 */
        .modal {
            z-index: 100;
        }
        /* 確保地圖在彈出視窗中正確顯示 */
        .shop-map {
            position: relative;
            z-index: 5;
        }
        /* Loading spinner styles (kept in case needed for other future features, can be removed) */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #34d399; /* Green */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <a href="#" class="text-2xl font-bold text-gray-800" data-i18n="appName">永續商店地圖</a>
            </div>
            <div class="hidden md:flex space-x-6 items-center">
                <a href="#" class="text-gray-700 hover:text-green-600 transition" data-i18n="home">首頁</a>
                <a href="#map" class="text-gray-700 hover:text-green-600 transition" data-i18n="map">地圖</a>
                <a href="#shops" class="text-gray-700 hover:text-green-600 transition" data-i18n="shopList">商店列表</a>
                <a href="#newsletter" class="text-gray-700 hover:text-green-600 transition" data-i18n="newsletter">訂閱電子報</a>
                <button id="language-toggle" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition">English</button>
            </div>
            <div class="md:hidden flex items-center">
                <button id="language-toggle-mobile" class="bg-green-500 text-white text-sm px-3 py-1 rounded-full hover:bg-green-700 transition mr-2">English</button>
                <button id="menu-toggle" class="text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden px-4 py-2 bg-white">
            <a href="#" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="home">首頁</a>
            <a href="#map" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="map">地圖</a>
            <a href="#shops" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="shopList">商店列表</a>
            <a href="#newsletter" class="block py-2 text-gray-700 hover:text-green-600" data-i18n="newsletter">訂閱電子報</a>
        </div>
    </nav>

    <section class="hero-section py-20 md:py-32 text-white">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-6" data-i18n="heroTitle">探索台灣永續商店</h1>
            <p class="text-xl max-w-2xl mx-auto mb-8" data-i18n="heroSubtitle">找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力</p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <a href="#map" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="viewMapBtn">查看地圖</a>
                <a href="#shops" class="bg-white text-green-600 px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="browseShopsBtn">瀏覽商店列表</a>
            </div>
        </div>
    </section>

    <section class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-4" data-i18n="searchTitle">搜尋永續商店</h2>
                        <div class="flex">
                            <input type="text" id="search-input" placeholder="" class="flex-1 px-4 py-3 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" data-i18n="searchPlaceholder">
                            <button id="search-button" class="btn-primary px-6 py-3 rounded-r-lg">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-medium mb-3" data-i18n="filterCategoryTitle">依類別篩選</h3>
                        <div class="flex flex-wrap gap-2" id="filter-buttons-container">
                            <button class="tag px-3 py-1 rounded-full text-sm active" data-i18n="filterAll" data-category="all">全部</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterApparel" data-category="apparel">服飾</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterFood" data-category="food">食品</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterCafe" data-category="cafe">咖啡廳</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterHomeGoods" data-category="homeGoods">家居用品</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterZeroWaste" data-category="zeroWaste">無包裝商店</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterSecondHand" data-category="secondHand">二手商店</button>
                            <button class="tag px-3 py-1 rounded-full text-sm" data-i18n="filterCreative" data-category="creative">文創</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="map" class="py-12 bg-green-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="mapSectionTitle">永續商店地圖</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="map-container">
                    <div id="sustainability-map" class="h-96 md:h-[500px] w-full"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="shops" class="py-12 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8" data-i18n="shopListSectionTitle">永續商店列表</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="shop-cards-container">
                </div>
            <div class="text-center mt-8">
                <button id="load-more-button" class="btn-primary px-8 py-3 rounded-lg font-medium" data-i18n="loadMoreBtn">載入更多</button>
            </div>
        </div>
    </section>

    <section id="newsletter" class="py-12 bg-green-600 text-white">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto text-center">
                <h2 class="text-3xl font-bold mb-4" data-i18n="newsletterTitle">訂閱永續生活電子報</h2>
                <p class="mb-6" data-i18n="newsletterSubtitle">獲取最新的永續商店資訊、環保生活技巧和特別優惠</p>
                <div class="flex flex-col md:flex-row gap-2">
                    <input type="email" placeholder="" class="flex-1 px-4 py-3 rounded-lg text-gray-800 focus:outline-none" data-i18n="newsletterPlaceholder">
                    <button class="bg-white text-green-600 px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition" data-i18n="subscribeBtn">訂閱</button>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-gray-800 text-white py-10">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="footerAppName">永續商店地圖</h3>
                    <p class="text-gray-300" data-i18n="footerAppDescription">幫助消費者找到並支持永續發展的商店，一起為地球盡一份心力。</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="contactUsTitle">聯絡我們</h3>
                    <p class="text-gray-300" data-i18n="contactUsText">有任何問題或建議，歡迎與我們聯繫</p>
                    <p class="text-gray-300" data-i18n="contactUsEmail">電子郵件：info@sustainablemap.tw</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4" data-i18n="followUsTitle">關注我們</h3>
                    <div class="flex space-x-4">
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"/>
                            </svg>
                        </a>
                        <a href="#" class="text-white hover:text-green-400 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p data-i18n="copyright">© 2023 永續商店地圖 - 版權所有</p>
            </div>
        </div>
    </footer>

    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center modal">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content">
            <div id="shop-detail-content" class="relative">
                </div>
        </div>
    </div>

    <div id="custom-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto text-center">
            <p id="message-modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button id="close-message-modal" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="okButton">確定</button>
        </div>
    </div>

    <script type="module">
        // Firebase 模組導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

        // Firebase 配置
        const firebaseConfig = {
          apiKey: "AIzaSyBe4RmOd4K3L8oVlANLX_1xmAyhsY0eB4k",
          authDomain: "green-1de30.firebaseapp.com",
          projectId: "green-1de30",
          storageBucket: "green-1de30.firebasestorage.app",
          messagingSenderId: "761812308263",
          appId: "1:761812308263:web:d82a416652dd975dff5902",
          measurementId: "G-XG5VV6QMGB"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let shopsCollectionRef; // Firestore 集合引用
        let allShopsData = []; // 用於儲存從 Firestore 獲取的所有商店數據

        // Firebase 認證：使用 Canvas 環境提供的 token，否則匿名登入
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 如果是 Canvas 環境，使用 __app_id 構建集合路徑
                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; // 使用 firebaseConfig.appId 作為 fallback
                // 這裡的 'shops' 是 Firestore 集合的名稱
                // 請確認您在 Firebase Console 的 Firestore Database 中建立了一個名為 'shops' 的集合
                // 如果您的應用程式是在 Canvas 環境中部署，路徑會是 `artifacts/${appId}/public/data/shops`
                // 否則，您可以直接使用 `collection(db, "shops")`
                // 根據您提供的錯誤，我將路徑調整為更通用的 Canvas 環境路徑
                // 如果您在 Firestore 中資料是直接在 'shops' 集合下，請將這行改回：
                // shopsCollectionRef = collection(db, "shops");
                shopsCollectionRef = collection(db, `artifacts/${appId}/public/data/shops`); 
                console.log("Firebase authenticated as:", user.uid);
                console.log("Firestore collection path:", shopsCollectionRef.path);
                setupFirestoreListener(); // 認證成功後設定 Firestore 監聽器
            } else {
                console.log("No user signed in. Attempting anonymous sign-in.");
                try {
                    // 檢查 __initial_auth_token 是否存在
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    showMessageModal("無法連接到資料庫，請檢查網路或專案設定。");
                }
            }
        });

        // Language translation data
        const translations = {
            'zh-TW': {
                pageTitle: '永續商店地圖 - 首頁',
                appName: '永續商店地圖',
                home: '首頁',
                map: '地圖',
                shopList: '商店列表',
                newsletter: '訂閱電子報',
                languageToggle: 'English',
                heroTitle: '探索台灣永續商店',
                heroSubtitle: '找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力',
                viewMapBtn: '查看地圖',
                browseShopsBtn: '瀏覽商店列表',
                searchTitle: '搜尋永續商店',
                searchPlaceholder: '輸入商店名稱或地址...',
                filterCategoryTitle: '依類別篩選',
                filterAll: '全部',
                filterApparel: '服飾',
                filterFood: '食品',
                filterCafe: '咖啡廳',
                filterHomeGoods: '家居用品',
                filterZeroWaste: '無包裝商店',
                filterSecondHand: '二手商店',
                filterCreative: '文創',
                mapSectionTitle: '永續商店地圖',
                shopListSectionTitle: '永續商店列表',
                viewDetailsBtn: '查看詳情',
                loadMoreBtn: '載入更多',
                newsletterTitle: '訂閱永續生活電子報',
                newsletterSubtitle: '獲取最新的永續商店資訊、環保生活技巧和特別優惠',
                newsletterPlaceholder: '您的電子郵件',
                subscribeBtn: '訂閱',
                footerAppName: '永續商店地圖',
                footerAppDescription: '幫助消費者找到並支持永續發展的商店，一起為地球盡一份心力。',
                contactUsTitle: '聯絡我們',
                contactUsText: '有任何問題或建議，歡迎與我們聯繫',
                contactUsEmail: '電子郵件：info@sustainablemap.tw',
                followUsTitle: '關注我們',
                copyright: '© 2023 永續商店地圖 - 版權所有',
                modalAboutUs: '關於我們',
                modalSustainability: '永續理念',
                modalVideoIntro: '影片介紹',
                modalLatestCollections: '最新系列',
                modalShopInfo: '商店資訊',
                modalAddress: '地址',
                modalOpeningHours: '營業時間',
                modalContactInfo: '聯絡方式',
                modalPhone: '電話',
                modalEmail: 'Email',
                modalWebsite: '網站',
                modalSocialMedia: '社群媒體',
                modalLocation: '位置',
                shopDetailsNotAvailable: '此店家詳情尚未建立，敬請期待！',
                okButton: '確定',
                notProvided: '未提供'
            },
            'en': {
                pageTitle: 'Sustainable Store Map - Home',
                appName: 'Sustainable Store Map',
                home: 'Home',
                map: 'Map',
                shopList: 'Shop List',
                newsletter: 'Newsletter',
                languageToggle: 'Français',
                heroTitle: 'Explore Taiwan\'s Sustainable Stores',
                heroSubtitle: 'Find stores that support environmental protection, fair trade, and sustainable development, and contribute to the Earth together.',
                viewMapBtn: 'View Details',
                browseShopsBtn: 'Browse Shop List',
                searchTitle: 'Search Sustainable Stores',
                searchPlaceholder: 'Enter store name or address...',
                filterCategoryTitle: 'Filter by Category',
                filterAll: 'All',
                filterApparel: 'Apparel',
                filterFood: 'Food',
                filterCafe: 'Cafe',
                filterHomeGoods: 'Home Goods',
                filterZeroWaste: 'Zero-Waste Stores',
                filterSecondHand: 'Second-hand Stores',
                filterCreative: 'Creative & Cultural',
                mapSectionTitle: 'Sustainable Store Map',
                shopListSectionTitle: 'Sustainable Shop List',
                viewDetailsBtn: 'View Details',
                loadMoreBtn: 'Load More',
                newsletterTitle: 'Subscribe to Sustainable Living Newsletter',
                newsletterSubtitle: 'Get the latest sustainable store information, eco-friendly living tips, and special offers',
                newsletterPlaceholder: 'Your email',
                subscribeBtn: 'Subscribe',
                footerAppName: 'Sustainable Store Map',
                footerAppDescription: 'Helping consumers find and support sustainable development stores, contributing to the Earth together.',
                contactUsTitle: 'Contact Us',
                contactUsText: 'For any questions or suggestions, please contact us',
                contactUsEmail: 'Email: info@sustainablemap.tw',
                followUsTitle: 'Follow Us',
                copyright: '© 2023 Sustainable Store Map - All Rights Reserved',
                modalAboutUs: 'About Us',
                modalSustainability: 'Sustainability Philosophy',
                modalVideoIntro: 'Video Introduction',
                modalLatestCollections: 'Latest Collections',
                modalShopInfo: 'Store Information',
                modalAddress: 'Address',
                modalOpeningHours: 'Opening Hours',
                modalContactInfo: 'Contact Info',
                modalPhone: 'Phone',
                modalEmail: 'Email',
                modalWebsite: 'Website',
                modalSocialMedia: 'Social Media',
                modalLocation: 'Location',
                shopDetailsNotAvailable: 'Shop details not yet available, please look forward to it!',
                okButton: 'OK',
                notProvided: 'Not provided'
            },
            'fr': {
                pageTitle: 'Carte des Magasins Durables - Accueil',
                appName: 'Carte des Magasins Durables',
                home: 'Accueil',
                map: 'Carte',
                shopList: 'Liste des Magasins',
                newsletter: 'Newsletter',
                languageToggle: 'Deutsch',
                heroTitle: 'Découvrez les Magasins Durables de Taïwan',
                heroSubtitle: 'Trouvez des magasins qui soutiennent la protection de l\'environnement, le commerce équitable et le développement durable, et contribuez à la Terre ensemble.',
                viewMapBtn: 'Voir les détails',
                browseShopsBtn: 'Parcourir les magasins',
                searchTitle: 'Rechercher des Magasins Durables',
                searchPlaceholder: 'Entrez le nom ou l\'adresse du magasin...',
                filterCategoryTitle: 'Filtrer par catégorie',
                filterAll: 'Tout',
                filterApparel: 'Vêtements',
                filterFood: 'Alimentation',
                filterCafe: 'Café',
                filterHomeGoods: 'Articles ménagers',
                filterZeroWaste: 'Magasins zéro déchet',
                filterSecondHand: 'Magasins d\'occasion',
                filterCreative: 'Créatif & Culturel',
                mapSectionTitle: 'Carte des Magasins Durables',
                shopListSectionTitle: 'Liste des Magasins Durables',
                viewDetailsBtn: 'Voir les détails',
                loadMoreBtn: 'Charger plus',
                newsletterTitle: 'Abonnez-vous à la Newsletter Vie Durable',
                newsletterSubtitle: 'Recevez les dernières informations sur les magasins durables, des conseils de vie écologique et des offres spéciales',
                newsletterPlaceholder: 'Votre e-mail',
                subscribeBtn: 'S\'abonner',
                footerAppName: 'Carte des Magasins Durables',
                footerAppDescription: 'Aider les consommateurs à trouver et à soutenir les magasins de développement durable, contribuant ainsi à la Terre ensemble.',
                contactUsTitle: 'Contactez-nous',
                contactUsText: 'Pour toute question ou suggestion, veuillez nous contacter',
                contactUsEmail: 'E-mail: info@sustainablemap.tw',
                followUsTitle: 'Suivez-us',
                copyright: '© 2023 Carte des Magasins Durables - Tous droits réservés',
                modalAboutUs: 'À propos de nous',
                modalSustainability: 'Philosophie de Durabilité',
                modalVideoIntro: 'Introduction vidéo',
                modalLatestCollections: 'Dernières Collections',
                modalShopInfo: 'Informations sur le magasin',
                modalAddress: 'Adresse',
                modalOpeningHours: 'Heures d\'ouverture',
                modalContactInfo: 'Coordonnées',
                modalPhone: 'Téléphone',
                modalEmail: 'E-mail',
                modalWebsite: 'Site web',
                modalSocialMedia: 'Médias sociaux',
                modalLocation: 'Emplacement',
                shopDetailsNotAvailable: 'Détails du magasin non encore disponibles, veuillez patienter !',
                okButton: 'OK',
                notProvided: 'Non fourni'
            },
            'de': {
                pageTitle: 'Karte der Nachhaltigen Geschäfte - Startseite',
                appName: 'Karte der Nachhaltigen Geschäfte',
                home: 'Startseite',
                map: 'Karte',
                shopList: 'Geschäftsliste',
                newsletter: 'Newsletter',
                languageToggle: 'Español',
                heroTitle: 'Entdecken Sie Taiwans Nachhaltige Geschäfte',
                heroSubtitle: 'Finden Sie Geschäfte, die Umweltschutz, fairen Handel und nachhaltige Entwicklung unterstützen, und leisten Sie gemeinsam einen Beitrag zur Erde.',
                viewMapBtn: 'Details anzeigen',
                browseShopsBtn: 'Geschäfte durchsuchen',
                searchTitle: 'Nach Nachhaltigen Geschäften suchen',
                searchPlaceholder: 'Geschäftsname oder Adresse eingeben...',
                filterCategoryTitle: 'Nach Kategorie filtern',
                filterAll: 'Alle',
                filterApparel: 'Bekleidung',
                filterFood: 'Lebensmittel',
                filterCafe: 'Café',
                filterHomeGoods: 'Haushaltswaren',
                filterZeroWaste: 'Unverpackt-Läden',
                filterSecondHand: 'Second-Hand-Läden',
                filterCreative: 'Kreativ & Kulturell',
                mapSectionTitle: 'Karte der Nachhaltigen Geschäfte',
                shopListSectionTitle: 'Liste der Nachhaltigen Geschäfte',
                viewDetailsBtn: 'Details anzeigen',
                loadMoreBtn: 'Mehr laden',
                newsletterTitle: 'Newsletter für Nachhaltiges Leben abonnieren',
                newsletterSubtitle: 'Erhalten Sie die neuesten Informationen zu nachhaltigen Geschäften, umweltfreundliche Wohntipps und Sonderangebote',
                newsletterPlaceholder: 'Ihre E-Mail',
                subscribeBtn: 'Abonnieren',
                footerAppName: 'Karte der Nachhaltigen Geschäfte',
                footerAppDescription: 'Konsumenten helfen, nachhaltige Entwicklungsgeschäfte zu finden und zu unterstützen, um gemeinsam einen Beitrag zur Erde zu leisten.',
                contactUsTitle: 'Kontaktieren Sie uns',
                contactUsText: 'Für Fragen oder Anregungen kontaktieren Sie uns bitte',
                contactUsEmail: 'E-Mail: info@sustainablemap.tw',
                followUsTitle: 'Folgen Sie uns',
                copyright: '© 2023 Karte der Nachhaltigen Geschäfte - Alle Rechte vorbehalten',
                modalAboutUs: 'Über uns',
                modalSustainability: 'Nachhaltigkeitsphilosophie',
                modalVideoIntro: 'Video-Einführung',
                modalLatestCollections: 'Neueste Kollektionen',
                modalShopInfo: 'Geschäftsinformationen',
                modalAddress: 'Adresse',
                modalOpeningHours: 'Öffnungszeiten',
                modalContactInfo: 'Kontaktinformationen',
                modalPhone: 'Telefon',
                modalEmail: 'E-Mail',
                modalWebsite: 'Webseite',
                modalSocialMedia: 'Soziale Medien',
                modalLocation: 'Standort',
                shopDetailsNotAvailable: 'Geschäftsdetails noch nicht verfügbar, bitte freuen Sie sich darauf!',
                okButton: 'OK',
                notProvided: 'Nicht angegeben'
            },
            'es': {
                pageTitle: 'Mapa de Tiendas Sostenibles - Inicio',
                appName: 'Mapa de Tiendas Sostenibles',
                home: 'Inicio',
                map: 'Mapa',
                shopList: 'Lista de Tiendas',
                newsletter: 'Boletín',
                languageToggle: '繁體中文',
                heroTitle: 'Explora Tiendas Sostenibles en Taiwán',
                heroSubtitle: 'Encuentra tiendas que apoyan la protección del medio ambiente, el comercio justo y el desarrollo sostenible, y contribuye a la Tierra juntos.',
                viewMapBtn: 'Ver detalles',
                browseShopsBtn: 'Explorar tiendas',
                searchTitle: 'Buscar Tiendas Sostenibles',
                searchPlaceholder: 'Introduce el nombre o la dirección de la tienda...',
                filterCategoryTitle: 'Filtrar por categoría',
                filterAll: 'Todos',
                filterApparel: 'Ropa',
                filterFood: 'Alimentos',
                filterCafe: 'Cafetería',
                filterHomeGoods: 'Artículos para el hogar',
                filterZeroWaste: 'Tiendas sin envases',
                filterSecondHand: 'Tiendas de segunda mano',
                filterCreative: 'Creativo y Cultural',
                mapSectionTitle: 'Mapa de Tiendas Sostenibles',
                shopListSectionTitle: 'Lista de Tiendas Sostenibles',
                viewDetailsBtn: 'Ver detalles',
                loadMoreBtn: 'Cargar más',
                newsletterTitle: 'Suscríbete al Boletín de Vida Sostenible',
                newsletterSubtitle: 'Recibe la última información sobre tiendas sostenibles, consejos de vida ecológica y ofertas especiales',
                newsletterPlaceholder: 'Tu correo electrónico',
                subscribeBtn: 'Suscribirse',
                footerAppName: 'Mapa de Tiendas Sostenibles',
                footerAppDescription: 'Ayudar a los consumidores a encontrar y apoyar tiendas de desarrollo sostenible, contribuyendo juntos a la Tierra.',
                contactUsTitle: 'Contáctanos',
                contactUsText: 'Para cualquier pregunta o sugerencia, por favor contáctanos',
                contactUsEmail: 'Correo electrónico: info@sustainablemap.tw',
                followUsTitle: 'Síguenos',
                copyright: '© 2023 Mapa de Tiendas Sostenibles - Todos los derechos reservados',
                modalAboutUs: 'Sobre nosotros',
                modalSustainability: 'Filosofía de Sostenibilidad',
                modalVideoIntro: 'Introducción en video',
                modalLatestCollections: 'Últimas Colecciones',
                modalShopInfo: 'Información de la tienda',
                modalAddress: 'Dirección',
                modalOpeningHours: 'Horario de apertura',
                modalContactInfo: 'Información de contacto',
                modalPhone: 'Teléfono',
                modalEmail: 'Correo electrónico',
                modalWebsite: 'Sitio web',
                modalSocialMedia: 'Redes sociales',
                modalLocation: 'Ubicación',
                shopDetailsNotAvailable: 'Detalles de la tienda aún no disponibles, ¡espere con ansias!',
                okButton: 'OK',
                notProvided: 'No proporcionado'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh-TW'; // Load from localStorage or default to Traditional Chinese
        let allShopsData = []; // 用於儲存從 Firestore 獲取的所有商店數據

        // --- 全局變數和篩選邏輯 ---
        let currentFilterCategory = 'all'; // 當前篩選類別
        let currentSearchQuery = ''; // 當前搜尋關鍵字
        const shopsPerPage = 6; // 每頁顯示的商店數量
        let currentLoadedShops = 0; // 當前已載入的商店數量
        let mapInstance; // Leaflet 地圖實例
        let markersGroup = L.featureGroup(); // 用於管理地圖上的標記
        const availableLanguages = ['zh-TW', 'en', 'fr', 'de', 'es']; // 可用的語言列表

        // Firestore 數據監聽器
        function setupFirestoreListener() {
            const shopsCol = collection(db, "shops");
            onSnapshot(shopsCol, (snapshot) => {
                allShopsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore data updated:", allShopsData);
                // 數據更新後重新篩選和顯示
                currentLoadedShops = 0; // 重置已載入數量
                filterAndDisplayShops();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showMessageModal("無法載入商店數據，請檢查網路連線。");
            });
        }

        // 設置語言函數
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang); // Save language preference

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Update language toggle button text
            const langToggleBtn = document.getElementById('language-toggle');
            const langToggleBtnMobile = document.getElementById('language-toggle-mobile');
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            langToggleBtn.textContent = translations[availableLanguages[nextIndex]].languageToggle; // 顯示下一個語言的切換文字
            langToggleBtnMobile.textContent = translations[availableLanguages[nextIndex]].languageToggle; // 顯示下一個語言的切換文字
            document.documentElement.lang = currentLang; // 更新 HTML 的 lang 屬性

            // Re-apply filters and re-render shop cards/map to update language
            currentLoadedShops = 0; // Reset loaded shops when language changes
            filterAndDisplayShops();

            // If a shop detail modal is open, re-render its content
            const shopDetailModal = document.getElementById('shop-detail-modal');
            if (!shopDetailModal.classList.contains('hidden')) {
                const currentShopId = shopDetailModal.dataset.shopId; // Get the ID of the currently open shop
                if (currentShopId) {
                    // Re-call showShopDetail to refresh content and map popup
                    showShopDetail(currentShopId); 
                }
            }
        }

        // 根據篩選條件過濾商店
        function getFilteredShops() {
            return allShopsData.filter(shop => { // 使用 allShopsData
                if (!shop || !shop.name || !shop.type || !shop.address || !shop.description) return false; // 基本數據檢查

                // 類別篩選
                const matchesCategory = currentFilterCategory === 'all' || 
                                        (shop.type[currentLang] && shop.type[currentLang].toLowerCase() === translations[currentLang]['filter' + currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1)].toLowerCase()) ||
                                        (shop.tags && shop.tags[currentLang] && shop.tags[currentLang].some(tag => tag.toLowerCase().includes(translations[currentLang]['filter' + currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1)].toLowerCase())));
                
                // 搜尋關鍵字 (多語言搜尋)
                const lowerCaseQuery = currentSearchQuery.toLowerCase();
                const matchesSearch = currentSearchQuery === '' ||
                                      (shop.name[currentLang] && shop.name[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.address[currentLang] && shop.address[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.description[currentLang] && shop.description[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.longDescription && shop.longDescription[currentLang] && shop.longDescription[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.sustainability && shop.sustainability[currentLang] && shop.sustainability[currentLang].toLowerCase().includes(lowerCaseQuery));
                
                return matchesCategory && matchesSearch;
            });
        }

        // 渲染商店卡片函數
        function renderShopCards(filteredShops) {
            const shopCardsContainer = document.getElementById('shop-cards-container');
            // 如果是新篩選或首次載入，則清空
            if (currentLoadedShops === 0) {
                shopCardsContainer.innerHTML = ''; 
            }

            const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
            
            shopsToDisplay.forEach(shop => {
                if (!shop) return;

                const cardHTML = `
                    <div class="shop-card bg-white rounded-xl overflow-hidden shadow-md">
                        <div class="h-48 bg-green-100 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold"><span class="math-inline">\{shop\.name\[currentLang\]\}</h3\>
<span class\="tag px\-2 py\-1 rounded\-full text\-xs"\></span>{shop.type[currentLang]}</span>
                            </div>
                            <p class="text-gray-600 mb-4">${shop.description[currentLang]}</p>
                            <div class="mb-4">
                                <div class="flex items-center text-gray-600 text-sm mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    ${shop.address[currentLang]}
                                </div>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span class="math-inline">\{shop\.hours\[currentLang\]\}
</div\>
</div\>
<button class\="block w\-full text\-center py\-2 bg\-green\-600 text\-white rounded\-lg hover\:bg\-green\-700 transition" onclick\="showShopDetail\('</span>{shop.id}')" data-i18n="viewDetailsBtn">${translations[currentLang].viewDetailsBtn}</button>
                        </div>
                    </div>
                `;
                shopCardsContainer.insertAdjacentHTML('beforeend', cardHTML);
            });

            currentLoadedShops += shopsToDisplay.length;
            updateLoadMoreButton(filteredShops.length);
        }

        // 更新地圖標記
        function updateMapMarkers(filteredShops) {
            markersGroup.clearLayers(); // 清除所有舊標記

            filteredShops.forEach(shop => {
                if (!shop || typeof shop.lat === 'undefined' || typeof shop.lng === 'undefined') return;
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`<b><span class="math-inline">\{shop\.name\[currentLang\]\}</b\><br\></span>{shop.type[currentLang]}<br><span class="math-inline">\{shop\.address\[currentLang\]\}<br\><a href\="\#" onclick\="showShopDetail\('</span>{shop.id}'); return false;" class="text-green-600">${translations[currentLang].viewDetailsBtn}</a>`);
                markersGroup.addLayer(marker);
            });
            mapInstance.addLayer(markersGroup);
        }

        // 篩選並顯示商店 (主控函數)
        function filterAndDisplayShops() {
            const filteredShops = getFilteredShops();
            renderShopCards(filteredShops);
            updateMapMarkers(filteredShops);
        }

        // 更新「載入更多」按鈕狀態
        function updateLoadMoreButton(totalFilteredShops) {
            const loadMoreButton = document.getElementById('load-more-button');
            if (currentLoadedShops < totalFilteredShops) {
                loadMoreButton.classList.remove('hidden');
            } else {
                loadMoreButton.classList.add('hidden');
            }
        }

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Initialize map after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
            
            markersGroup.addTo(mapInstance); // 將標記群組添加到地圖

            // Initial language setup, which triggers filterAndDisplayShops
            setLanguage(currentLang);

            // --- 事件監聽器 ---
            // 搜尋按鈕
            document.getElementById('search-button').addEventListener('click', () => {
                currentSearchQuery = document.getElementById('search-input').value.trim();
                currentLoadedShops = 0; // 重置載入數量
                filterAndDisplayShops();
            });

            // 搜尋輸入框 Enter 鍵
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-button').click();
                }
            });

            // 類別篩選按鈕
            document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.tag');
                if (clickedButton) {
                    document.querySelectorAll('#filter-buttons-container .tag').forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    currentFilterCategory = clickedButton.dataset.category;
                    currentLoadedShops = 0; // 重置載入數量
                    filterAndDisplayShops();
                }
            });

            // 載入更多按鈕
            document.getElementById('load-more-button').addEventListener('click', () => {
                filterAndDisplayShops(); // 繼續載入更多
            });
        });

        // Language toggle button event listeners
        document.getElementById('language-toggle').addEventListener('click', function() {
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            setLanguage(availableLanguages[nextIndex]);
        });
        document.getElementById('language-toggle-mobile').addEventListener('click', function() {
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            setLanguage(availableLanguages[nextIndex]);
        });


        // Display shop details
        function showShopDetail(shopId) {
            // 從 allShopsData 中查找商店
            const shop = allShopsData.find(s => s.id === shopId);
            if (!shop) {
                showMessageModal(translations[currentLang].shopDetailsNotAvailable);
                return;
            }

            // Store the shopId in the modal for language switching
            document.getElementById('shop-detail-modal').dataset.shopId = shopId;

            // Prepare detail content
            let detailHTML = `
                <div class="shop-detail-header py-12 text-white rounded-t-xl">
                    <div class="container mx-auto px-4 text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2"><span class="math-inline">\{shop\.name\[currentLang\]\}</h1\>
<p class\="text\-lg"\></span>{shop.type[currentLang]}</p>
                    </div>
                </div>
                <button id="close-modal" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-md z-[1010]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalAboutUs"><span class="math-inline">\{translations\[currentLang\]\.modalAboutUs\}</h2\>
<p class\="text\-gray\-700 mb\-4"\></span>{shop.description[currentLang]}</p>
                            ${shop.longDescription && shop.longDescription[currentLang] ? `<p class="text-gray-700 mb-6">${shop.longDescription[currentLang]}</p>` : ''}
                            
                            ${shop.sustainability && shop.sustainability[currentLang] ? `
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalSustainability">${translations[currentLang].modalSustainability}</h2>
                            <div class="mb-6">
                                <p class="text-gray-700 mb-4">${shop.sustainability[currentLang]}</p>
                                ${shop.tags && shop.tags[currentLang] && shop.tags[currentLang].length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${shop.tags[currentLang].map(tag => `<span class="tag px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                            ` : ''}
                            
                            ${shop.videoId ? `
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalVideoIntro">${translations[currentLang].modalVideoIntro}</h2>
                            <div class="video-container mb-6">
                                <iframe src="https://www.youtube.com/embed/${shop.videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                            </div>
                            ` : ''}
                            
                            ${shop.collections && shop.collections.length > 0 ? `
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalLatestCollections">${translations[currentLang].modalLatestCollections}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                ${shop.collections.map(collection => `
                                <div class="bg-green-50 rounded-lg p-4">
                                    <div class="h-32 bg-green-100 rounded-lg flex items-center justify-center mb-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    <h3 class="text-lg font-bold mb-2"><span class="math-inline">\{collection\.name\[currentLang\]\}</h3\>
<p class\="text\-gray\-600"\></span>{collection.description[currentLang]}</p>
                                </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="bg-green-50 p-6 rounded-xl">
                            <h3 class="text-xl font-bold mb-4" data-i18n-dynamic="modalShopInfo"><span class="math-inline">\{translations\[currentLang\]\.modalShopInfo\}</h3\>
<div class\="space\-y\-4"\>
<div\>
<h4 class\="font\-medium text\-gray\-700" data\-i18n\-dynamic\="modalAddress"\></span>{translations[currentLang].modalAddress}</h4>
                                    <p class="text-gray-600"><span class="math-inline">\{shop\.address\[currentLang\]\}</p\>
</div\>
<div\>
<h4 class\="font\-medium text\-gray\-700" data\-i18n\-dynamic\="modalOpeningHours"\></span>{translations[currentLang].modalOpeningHours}</h4>
                                    <p class="text-gray-600"><span class="math-inline">\{shop\.hours\[currentLang\]\}</p\>
</div\>
<div\>
<h4 class\="font\-medium text\-gray\-700" data\-i18n\-dynamic\="modalContactInfo"\></span>{translations[currentLang].modalContactInfo}</h4>
                                    <p class="text-gray-600" data-i18n-dynamic="modalPhone">${translations[currentLang].modalPhone}: <span class="math-inline">\{shop\.phone \|\| translations\[currentLang\]\.notProvided\}</p\>
<p class\="text\-gray\-600" data\-i18n\-dynamic\="modalEmail"\></span>{translations[currentLang].modalEmail}: ${shop.email || translations[currentLang].notProvided}</p>
                                    ${shop.website ? `<p class="text-gray-600" data-i18n-dynamic="modalWebsite">${translations[currentLang].modalWebsite}: <a href="https://${shop.website}" target="_blank" class="text-green-600 hover:underline">${shop.website}</a></p>` : ''}
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-700" data-i18n-dynamic="modalSocialMedia">${translations[currentLang].modalSocialMedia}</h4>
                                    <div class="flex space-x-3 mt-2">
                                        <a href="#" class="text-green-600 hover:text-green-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M22.675 0h-21.35c-.732 0-1.325.593-1.325 1.325v21.351c0 .731.593 1.324 1.325 1.324h11.495v-9.294h-3.128v-3.622h3.128v-2.671c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12v9.293h6.116c.73 0 1.323-.593 1.323-1.325v-21.35c0-.732-.593-1.325-1.325-1.325z"/>
                                            </svg>
                                        </a>
                                        <a href="#" class="text-green-600 hover:text-green-800">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p data-i18n="copyright">© 2023 永續商店地圖 - 版權所有</p>
            </div>
        </div>
    </footer>

    <div id="shop-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden flex items-center justify-center modal">
        <div class="bg-white rounded-xl max-w-4xl w-full mx-4 modal-content">
            <div id="shop-detail-content" class="relative">
                </div>
        </div>
    </div>

    <div id="custom-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[2000] hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm mx-auto text-center">
            <p id="message-modal-text" class="text-gray-800 text-lg mb-4"></p>
            <button id="close-message-modal" class="btn-primary px-6 py-2 rounded-lg font-medium" data-i18n="okButton">確定</button>
        </div>
    </div>

    <script type="module">
        // Firebase 模組導入
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

        // Firebase 配置
        const firebaseConfig = {
          apiKey: "AIzaSyBe4RmOd4K3L8oVlANLX_1xmAyhsY0eB4k",
          authDomain: "green-1de30.firebaseapp.com",
          projectId: "green-1de30",
          storageBucket: "green-1de30.firebasestorage.app",
          messagingSenderId: "761812308263",
          appId: "1:761812308263:web:d82a416652dd975dff5902",
          measurementId: "G-XG5VV6QMGB"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let shopsCollectionRef; // Firestore 集合引用
        let allShopsData = []; // 用於儲存從 Firestore 獲取的所有商店數據

        // Firebase 認證：使用 Canvas 環境提供的 token，否則匿名登入
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 如果是 Canvas 環境，使用 __app_id 構建集合路徑
                const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId; // 使用 firebaseConfig.appId 作為 fallback
                // 這裡的 'shops' 是 Firestore 集合的名稱
                // 請確認您在 Firebase Console 的 Firestore Database 中建立了一個名為 'shops' 的集合
                // 如果您的應用程式是在 Canvas 環境中部署，路徑會是 `artifacts/${appId}/public/data/shops`
                // 否則，您可以直接使用 `collection(db, "shops")`
                // 根據您提供的錯誤，我將路徑調整為更通用的 Canvas 環境路徑
                // 如果您在 Firestore 中資料是直接在 'shops' 集合下，請將這行改回：
                // shopsCollectionRef = collection(db, "shops");
                shopsCollectionRef = collection(db, `artifacts/${appId}/public/data/shops`); 
                console.log("Firebase authenticated as:", user.uid);
                console.log("Firestore collection path:", shopsCollectionRef.path);
                setupFirestoreListener(); // 認證成功後設定 Firestore 監聽器
            } else {
                console.log("No user signed in. Attempting anonymous sign-in.");
                try {
                    // 檢查 __initial_auth_token 是否存在
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase authentication failed:", error);
                    showMessageModal("無法連接到資料庫，請檢查網路或專案設定。");
                }
            }
        });

        // Language translation data
        const translations = {
            'zh-TW': {
                pageTitle: '永續商店地圖 - 首頁',
                appName: '永續商店地圖',
                home: '首頁',
                map: '地圖',
                shopList: '商店列表',
                newsletter: '訂閱電子報',
                languageToggle: 'English',
                heroTitle: '探索台灣永續商店',
                heroSubtitle: '找到支持環保、公平貿易和永續發展的商店，一起為地球盡一份心力',
                viewMapBtn: '查看地圖',
                browseShopsBtn: '瀏覽商店列表',
                searchTitle: '搜尋永續商店',
                searchPlaceholder: '輸入商店名稱或地址...',
                filterCategoryTitle: '依類別篩選',
                filterAll: '全部',
                filterApparel: '服飾',
                filterFood: '食品',
                filterCafe: '咖啡廳',
                filterHomeGoods: '家居用品',
                filterZeroWaste: '無包裝商店',
                filterSecondHand: '二手商店',
                filterCreative: '文創',
                mapSectionTitle: '永續商店地圖',
                shopListSectionTitle: '永續商店列表',
                viewDetailsBtn: '查看詳情',
                loadMoreBtn: '載入更多',
                newsletterTitle: '訂閱永續生活電子報',
                newsletterSubtitle: '獲取最新的永續商店資訊、環保生活技巧和特別優惠',
                newsletterPlaceholder: '您的電子郵件',
                subscribeBtn: '訂閱',
                footerAppName: '永續商店地圖',
                footerAppDescription: '幫助消費者找到並支持永續發展的商店，一起為地球盡一份心力。',
                contactUsTitle: '聯絡我們',
                contactUsText: '有任何問題或建議，歡迎與我們聯繫',
                contactUsEmail: '電子郵件：info@sustainablemap.tw',
                followUsTitle: '關注我們',
                copyright: '© 2023 永續商店地圖 - 版權所有',
                modalAboutUs: '關於我們',
                modalSustainability: '永續理念',
                modalVideoIntro: '影片介紹',
                modalLatestCollections: '最新系列',
                modalShopInfo: '商店資訊',
                modalAddress: '地址',
                modalOpeningHours: '營業時間',
                modalContactInfo: '聯絡方式',
                modalPhone: '電話',
                modalEmail: 'Email',
                modalWebsite: '網站',
                modalSocialMedia: '社群媒體',
                modalLocation: '位置',
                shopDetailsNotAvailable: '此店家詳情尚未建立，敬請期待！',
                okButton: '確定',
                notProvided: '未提供'
            },
            'en': {
                pageTitle: 'Sustainable Store Map - Home',
                appName: 'Sustainable Store Map',
                home: 'Home',
                map: 'Map',
                shopList: 'Shop List',
                newsletter: 'Newsletter',
                languageToggle: 'Français',
                heroTitle: 'Explore Taiwan\'s Sustainable Stores',
                heroSubtitle: 'Find stores that support environmental protection, fair trade, and sustainable development, and contribute to the Earth together.',
                viewMapBtn: 'View Details',
                browseShopsBtn: 'Browse Shop List',
                searchTitle: 'Search Sustainable Stores',
                searchPlaceholder: 'Enter store name or address...',
                filterCategoryTitle: 'Filter by Category',
                filterAll: 'All',
                filterApparel: 'Apparel',
                filterFood: 'Food',
                filterCafe: 'Cafe',
                filterHomeGoods: 'Home Goods',
                filterZeroWaste: 'Zero-Waste Stores',
                filterSecondHand: 'Second-hand Stores',
                filterCreative: 'Creative & Cultural',
                mapSectionTitle: 'Sustainable Store Map',
                shopListSectionTitle: 'Sustainable Shop List',
                viewDetailsBtn: 'View Details',
                loadMoreBtn: 'Load More',
                newsletterTitle: 'Subscribe to Sustainable Living Newsletter',
                newsletterSubtitle: 'Get the latest sustainable store information, eco-friendly living tips, and special offers',
                newsletterPlaceholder: 'Your email',
                subscribeBtn: 'Subscribe',
                footerAppName: 'Sustainable Store Map',
                footerAppDescription: 'Helping consumers find and support sustainable development stores, contributing to the Earth together.',
                contactUsTitle: 'Contact Us',
                contactUsText: 'For any questions or suggestions, please contact us',
                contactUsEmail: 'Email: info@sustainablemap.tw',
                followUsTitle: 'Follow Us',
                copyright: '© 2023 Sustainable Store Map - All Rights Reserved',
                modalAboutUs: 'About Us',
                modalSustainability: 'Sustainability Philosophy',
                modalVideoIntro: 'Video Introduction',
                modalLatestCollections: 'Latest Collections',
                modalShopInfo: 'Store Information',
                modalAddress: 'Address',
                modalOpeningHours: 'Opening Hours',
                modalContactInfo: 'Contact Info',
                modalPhone: 'Phone',
                modalEmail: 'Email',
                modalWebsite: 'Website',
                modalSocialMedia: 'Social Media',
                modalLocation: 'Location',
                shopDetailsNotAvailable: 'Shop details not yet available, please look forward to it!',
                okButton: 'OK',
                notProvided: 'Not provided'
            },
            'fr': {
                pageTitle: 'Carte des Magasins Durables - Accueil',
                appName: 'Carte des Magasins Durables',
                home: 'Accueil',
                map: 'Carte',
                shopList: 'Liste des Magasins',
                newsletter: 'Newsletter',
                languageToggle: 'Deutsch',
                heroTitle: 'Découvrez les Magasins Durables de Taïwan',
                heroSubtitle: 'Trouvez des magasins qui soutiennent la protection de l\'environnement, le commerce équitable et le développement durable, et contribuez à la Terre ensemble.',
                viewMapBtn: 'Voir les détails',
                browseShopsBtn: 'Parcourir les magasins',
                searchTitle: 'Rechercher des Magasins Durables',
                searchPlaceholder: 'Entrez le nom ou l\'adresse du magasin...',
                filterCategoryTitle: 'Filtrer par catégorie',
                filterAll: 'Tout',
                filterApparel: 'Vêtements',
                filterFood: 'Alimentation',
                filterCafe: 'Café',
                filterHomeGoods: 'Articles ménagers',
                filterZeroWaste: 'Magasins zéro déchet',
                filterSecondHand: 'Magasins d\'occasion',
                filterCreative: 'Créatif & Culturel',
                mapSectionTitle: 'Carte des Magasins Durables',
                shopListSectionTitle: 'Liste des Magasins Durables',
                viewDetailsBtn: 'Voir les détails',
                loadMoreBtn: 'Charger plus',
                newsletterTitle: 'Abonnez-vous à la Newsletter Vie Durable',
                newsletterSubtitle: 'Recevez les dernières informations sur les magasins durables, des conseils de vie écologique et des offres spéciales',
                newsletterPlaceholder: 'Votre e-mail',
                subscribeBtn: 'S\'abonner',
                footerAppName: 'Carte des Magasins Durables',
                footerAppDescription: 'Aider les consommateurs à trouver et à soutenir les magasins de développement durable, contribuant ainsi à la Terre ensemble.',
                contactUsTitle: 'Contactez-us',
                contactUsText: 'Pour toute question ou suggestion, veuillez nous contacter',
                contactUsEmail: 'E-mail: info@sustainablemap.tw',
                followUsTitle: 'Suivez-us',
                copyright: '© 2023 Carte des Magasins Durables - Tous droits réservés',
                modalAboutUs: 'À propos de nous',
                modalSustainability: 'Philosophie de Durabilité',
                modalVideoIntro: 'Introduction vidéo',
                modalLatestCollections: 'Dernières Collections',
                modalShopInfo: 'Informations sur le magasin',
                modalAddress: 'Adresse',
                modalOpeningHours: 'Heures d\'ouverture',
                modalContactInfo: 'Coordonnées',
                modalPhone: 'Téléphone',
                modalEmail: 'E-mail',
                modalWebsite: 'Site web',
                modalSocialMedia: 'Médias sociaux',
                modalLocation: 'Emplacement',
                shopDetailsNotAvailable: 'Détails du magasin non encore disponibles, veuillez patienter !',
                okButton: 'OK',
                notProvided: 'Non fourni'
            },
            'de': {
                pageTitle: 'Karte der Nachhaltigen Geschäfte - Startseite',
                appName: 'Karte der Nachhaltigen Geschäfte',
                home: 'Startseite',
                map: 'Karte',
                shopList: 'Geschäftsliste',
                newsletter: 'Newsletter',
                languageToggle: 'Español',
                heroTitle: 'Entdecken Sie Taiwans Nachhaltige Geschäfte',
                heroSubtitle: 'Finden Sie Geschäfte, die Umweltschutz, fairen Handel und nachhaltige Entwicklung unterstützen, und leisten Sie gemeinsam einen Beitrag zur Erde.',
                viewMapBtn: 'Details anzeigen',
                browseShopsBtn: 'Geschäfte durchsuchen',
                searchTitle: 'Nach Nachhaltigen Geschäften suchen',
                searchPlaceholder: 'Geschäftsname oder Adresse eingeben...',
                filterCategoryTitle: 'Nach Kategorie filtern',
                filterAll: 'Alle',
                filterApparel: 'Bekleidung',
                filterFood: 'Lebensmittel',
                filterCafe: 'Café',
                filterHomeGoods: 'Haushaltswaren',
                filterZeroWaste: 'Unverpackt-Läden',
                filterSecondHand: 'Second-Hand-Läden',
                filterCreative: 'Kreativ & Kulturell',
                mapSectionTitle: 'Karte der Nachhaltigen Geschäfte',
                shopListSectionTitle: 'Liste der Nachhaltigen Geschäfte',
                viewDetailsBtn: 'Details anzeigen',
                loadMoreBtn: 'Mehr laden',
                newsletterTitle: 'Newsletter für Nachhaltiges Leben abonnieren',
                newsletterSubtitle: 'Erhalten Sie die neuesten Informationen zu nachhaltigen Geschäften, umweltfreundliche Wohntipps und Sonderangebote',
                newsletterPlaceholder: 'Ihre E-Mail',
                subscribeBtn: 'Abonnieren',
                footerAppName: 'Karte der Nachhaltigen Geschäfte',
                footerAppDescription: 'Konsumenten helfen, nachhaltige Entwicklungsgeschäfte zu finden und zu unterstützen, um gemeinsam einen Beitrag zur Erde zu leisten.',
                contactUsTitle: 'Kontaktieren Sie uns',
                contactUsText: 'Für Fragen oder Anregungen kontaktieren Sie uns bitte',
                contactUsEmail: 'E-Mail: info@sustainablemap.tw',
                followUsTitle: 'Folgen Sie uns',
                copyright: '© 2023 Karte der Nachhaltigen Geschäfte - Alle Rechte vorbehalten',
                modalAboutUs: 'Über uns',
                modalSustainability: 'Nachhaltigkeitsphilosophie',
                modalVideoIntro: 'Video-Einführung',
                modalLatestCollections: 'Neueste Kollektionen',
                modalShopInfo: 'Geschäftsinformationen',
                modalAddress: 'Adresse',
                modalOpeningHours: 'Öffnungszeiten',
                modalContactInfo: 'Kontaktinformationen',
                modalPhone: 'Telefon',
                modalEmail: 'E-Mail',
                modalWebsite: 'Webseite',
                modalSocialMedia: 'Soziale Medien',
                modalLocation: 'Standort',
                shopDetailsNotAvailable: 'Geschäftsdetails noch nicht verfügbar, bitte freuen Sie sich darauf!',
                okButton: 'OK',
                notProvided: 'Nicht angegeben'
            },
            'es': {
                pageTitle: 'Mapa de Tiendas Sostenibles - Inicio',
                appName: 'Mapa de Tiendas Sostenibles',
                home: 'Inicio',
                map: 'Mapa',
                shopList: 'Lista de Tiendas',
                newsletter: 'Boletín',
                languageToggle: '繁體中文',
                heroTitle: 'Explora Tiendas Sostenibles en Taiwán',
                heroSubtitle: 'Encuentra tiendas que apoyan la protección del medio ambiente, el comercio justo y el desarrollo sostenible, y contribuye a la Tierra juntos.',
                viewMapBtn: 'Ver detalles',
                browseShopsBtn: 'Explorar tiendas',
                searchTitle: 'Buscar Tiendas Sostenibles',
                searchPlaceholder: 'Introduce el nombre o la dirección de la tienda...',
                filterCategoryTitle: 'Filtrar por categoría',
                filterAll: 'Todos',
                filterApparel: 'Ropa',
                filterFood: 'Alimentos',
                filterCafe: 'Cafetería',
                filterHomeGoods: 'Artículos para el hogar',
                filterZeroWaste: 'Tiendas sin envases',
                filterSecondHand: 'Tiendas de segunda mano',
                filterCreative: 'Creativo y Cultural',
                mapSectionTitle: 'Mapa de Tiendas Sostenibles',
                shopListSectionTitle: 'Lista de Tiendas Sostenibles',
                viewDetailsBtn: 'Ver detalles',
                loadMoreBtn: 'Cargar más',
                newsletterTitle: 'Suscríbete al Boletín de Vida Sostenible',
                newsletterSubtitle: 'Recibe la última información sobre tiendas sostenibles, consejos de vida ecológica y ofertas especiales',
                newsletterPlaceholder: 'Tu correo electrónico',
                subscribeBtn: 'Suscribirse',
                footerAppName: 'Mapa de Tiendas Sostenibles',
                footerAppDescription: 'Ayudar a los consumidores a encontrar y apoyar tiendas de desarrollo sostenible, contribuyendo juntos a la Tierra.',
                contactUsTitle: 'Contáctanos',
                contactUsText: 'Para cualquier pregunta o sugerencia, por favor contáctanos',
                contactUsEmail: 'Correo electrónico: info@sustainablemap.tw',
                followUsTitle: 'Síguenos',
                copyright: '© 2023 Mapa de Tiendas Sostenibles - Todos los derechos reservados',
                modalAboutUs: 'Sobre nosotros',
                modalSustainability: 'Filosofía de Sostenibilidad',
                modalVideoIntro: 'Introducción en video',
                modalLatestCollections: 'Últimas Colecciones',
                modalShopInfo: 'Información de la tienda',
                modalAddress: 'Dirección',
                modalOpeningHours: 'Horario de apertura',
                modalContactInfo: 'Información de contacto',
                modalPhone: 'Teléfono',
                modalEmail: 'Correo electrónico',
                modalWebsite: 'Sitio web',
                modalSocialMedia: 'Redes sociales',
                modalLocation: 'Ubicación',
                shopDetailsNotAvailable: 'Detalles de la tienda aún no disponibles, ¡espere con ansias!',
                okButton: 'OK',
                notProvided: 'No proporcionado'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'zh-TW'; // Load from localStorage or default to Traditional Chinese
        let allShopsData = []; // 用於儲存從 Firestore 獲取的所有商店數據

        // --- 全局變數和篩選邏輯 ---
        let currentFilterCategory = 'all'; // 當前篩選類別
        let currentSearchQuery = ''; // 當前搜尋關鍵字
        const shopsPerPage = 6; // 每頁顯示的商店數量
        let currentLoadedShops = 0; // 當前已載入的商店數量
        let mapInstance; // Leaflet 地圖實例
        let markersGroup = L.featureGroup(); // 用於管理地圖上的標記
        const availableLanguages = ['zh-TW', 'en', 'fr', 'de', 'es']; // 可用的語言列表

        // Firestore 數據監聽器
        function setupFirestoreListener() {
            const shopsCol = collection(db, "shops");
            onSnapshot(shopsCol, (snapshot) => {
                allShopsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Firestore data updated:", allShopsData);
                // 數據更新後重新篩選和顯示
                currentLoadedShops = 0; // 重置已載入數量
                filterAndDisplayShops();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                showMessageModal("無法載入商店數據，請檢查網路連線。");
            });
        }

        // 設置語言函數
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang); // Save language preference

            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Update language toggle button text
            const langToggleBtn = document.getElementById('language-toggle');
            const langToggleBtnMobile = document.getElementById('language-toggle-mobile');
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            langToggleBtn.textContent = translations[availableLanguages[nextIndex]].languageToggle; // 顯示下一個語言的切換文字
            langToggleBtnMobile.textContent = translations[availableLanguages[nextIndex]].languageToggle; // 顯示下一個語言的切換文字
            document.documentElement.lang = currentLang; // 更新 HTML 的 lang 屬性

            // Re-apply filters and re-render shop cards/map to update language
            currentLoadedShops = 0; // Reset loaded shops when language changes
            filterAndDisplayShops();

            // If a shop detail modal is open, re-render its content
            const shopDetailModal = document.getElementById('shop-detail-modal');
            if (!shopDetailModal.classList.contains('hidden')) {
                const currentShopId = shopDetailModal.dataset.shopId; // Get the ID of the currently open shop
                if (currentShopId) {
                    // Re-call showShopDetail to refresh content and map popup
                    showShopDetail(currentShopId); 
                }
            }
        }

        // 根據篩選條件過濾商店
        function getFilteredShops() {
            return allShopsData.filter(shop => { // 使用 allShopsData
                if (!shop || !shop.name || !shop.type || !shop.address || !shop.description) return false; // 基本數據檢查

                // 類別篩選
                const matchesCategory = currentFilterCategory === 'all' || 
                                        (shop.type[currentLang] && shop.type[currentLang].toLowerCase() === translations[currentLang]['filter' + currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1)].toLowerCase()) ||
                                        (shop.tags && shop.tags[currentLang] && shop.tags[currentLang].some(tag => tag.toLowerCase().includes(translations[currentLang]['filter' + currentFilterCategory.charAt(0).toUpperCase() + currentFilterCategory.slice(1)].toLowerCase())));
                
                // 搜尋關鍵字 (多語言搜尋)
                const lowerCaseQuery = currentSearchQuery.toLowerCase();
                const matchesSearch = currentSearchQuery === '' ||
                                      (shop.name[currentLang] && shop.name[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.address[currentLang] && shop.address[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.description[currentLang] && shop.description[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.longDescription && shop.longDescription[currentLang] && shop.longDescription[currentLang].toLowerCase().includes(lowerCaseQuery)) ||
                                      (shop.sustainability && shop.sustainability[currentLang] && shop.sustainability[currentLang].toLowerCase().includes(lowerCaseQuery));
                
                return matchesCategory && matchesSearch;
            });
        }

        // 渲染商店卡片函數
        function renderShopCards(filteredShops) {
            const shopCardsContainer = document.getElementById('shop-cards-container');
            // 如果是新篩選或首次載入，則清空
            if (currentLoadedShops === 0) {
                shopCardsContainer.innerHTML = ''; 
            }

            const shopsToDisplay = filteredShops.slice(currentLoadedShops, currentLoadedShops + shopsPerPage);
            
            shopsToDisplay.forEach(shop => {
                if (!shop) return;

                const cardHTML = `
                    <div class="shop-card bg-white rounded-xl overflow-hidden shadow-md">
                        <div class="h-48 bg-green-100 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                            </svg>
                        </div>
                        <div class="p-6">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold">${shop.name[currentLang]}</h3>
                                <span class="tag px-2 py-1 rounded-full text-xs">${shop.type[currentLang]}</span>
                            </div>
                            <p class="text-gray-600 mb-4">${shop.description[currentLang]}</p>
                            <div class="mb-4">
                                <div class="flex items-center text-gray-600 text-sm mb-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    ${shop.address[currentLang]}
                                </div>
                                <div class="flex items-center text-gray-600 text-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    ${shop.hours[currentLang]}
                                </div>
                            </div>
                            <button class="block w-full text-center py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" onclick="showShopDetail('${shop.id}')" data-i18n="viewDetailsBtn">${translations[currentLang].viewDetailsBtn}</button>
                        </div>
                    </div>
                `;
                shopCardsContainer.insertAdjacentHTML('beforeend', cardHTML);
            });

            currentLoadedShops += shopsToDisplay.length;
            updateLoadMoreButton(filteredShops.length);
        }

        // 更新地圖標記
        function updateMapMarkers(filteredShops) {
            markersGroup.clearLayers(); // 清除所有舊標記

            filteredShops.forEach(shop => {
                if (!shop || typeof shop.lat === 'undefined' || typeof shop.lng === 'undefined') return;
                const marker = L.marker([shop.lat, shop.lng]);
                marker.bindPopup(`<b>${shop.name[currentLang]}</b><br>${shop.type[currentLang]}<br>${shop.address[currentLang]}<br><a href="#" onclick="showShopDetail('${shop.id}'); return false;" class="text-green-600">${translations[currentLang].viewDetailsBtn}</a>`);
                markersGroup.addLayer(marker);
            });
            mapInstance.addLayer(markersGroup);
        }

        // 篩選並顯示商店 (主控函數)
        function filterAndDisplayShops() {
            const filteredShops = getFilteredShops();
            renderShopCards(filteredShops);
            updateMapMarkers(filteredShops);
        }

        // 更新「載入更多」按鈕狀態
        function updateLoadMoreButton(totalFilteredShops) {
            const loadMoreButton = document.getElementById('load-more-button');
            if (currentLoadedShops < totalFilteredShops) {
                loadMoreButton.classList.remove('hidden');
            } else {
                loadMoreButton.classList.add('hidden');
            }
        }

        // Mobile menu toggle
        document.getElementById('menu-toggle').addEventListener('click', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            mobileMenu.classList.toggle('hidden');
        });

        // Initialize map after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize map
            mapInstance = L.map('sustainability-map').setView([25.0330, 121.5654], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
            
            markersGroup.addTo(mapInstance); // 將標記群組添加到地圖

            // Initial language setup, which triggers filterAndDisplayShops
            setLanguage(currentLang);

            // --- 事件監聽器 ---
            // 搜尋按鈕
            document.getElementById('search-button').addEventListener('click', () => {
                currentSearchQuery = document.getElementById('search-input').value.trim();
                currentLoadedShops = 0; // 重置載入數量
                filterAndDisplayShops();
            });

            // 搜尋輸入框 Enter 鍵
            document.getElementById('search-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('search-button').click();
                }
            });

            // 類別篩選按鈕
            document.getElementById('filter-buttons-container').addEventListener('click', (e) => {
                const clickedButton = e.target.closest('.tag');
                if (clickedButton) {
                    document.querySelectorAll('#filter-buttons-container .tag').forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    currentFilterCategory = clickedButton.dataset.category;
                    currentLoadedShops = 0; // 重置載入數量
                    filterAndDisplayShops();
                }
            });

            // 載入更多按鈕
            document.getElementById('load-more-button').addEventListener('click', () => {
                filterAndDisplayShops(); // 繼續載入更多
            });
        });

        // Language toggle button event listeners
        document.getElementById('language-toggle').addEventListener('click', function() {
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            setLanguage(availableLanguages[nextIndex]);
        });
        document.getElementById('language-toggle-mobile').addEventListener('click', function() {
            const currentIndex = availableLanguages.indexOf(currentLang);
            const nextIndex = (currentIndex + 1) % availableLanguages.length;
            setLanguage(availableLanguages[nextIndex]);
        });


        // Display shop details
        function showShopDetail(shopId) {
            // 從 allShopsData 中查找商店
            const shop = allShopsData.find(s => s.id === shopId);
            if (!shop) {
                showMessageModal(translations[currentLang].shopDetailsNotAvailable);
                return;
            }

            // Store the shopId in the modal for language switching
            document.getElementById('shop-detail-modal').dataset.shopId = shopId;

            // Prepare detail content
            let detailHTML = `
                <div class="shop-detail-header py-12 text-white rounded-t-xl">
                    <div class="container mx-auto px-4 text-center">
                        <h1 class="text-3xl md:text-4xl font-bold mb-2">${shop.name[currentLang]}</h1>
                        <p class="text-lg">${shop.type[currentLang]}</p>
                    </div>
                </div>
                <button id="close-modal" class="absolute top-4 right-4 bg-white rounded-full p-2 shadow-md z-[1010]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalAboutUs">${translations[currentLang].modalAboutUs}</h2>
                            <p class="text-gray-700 mb-4">${shop.description[currentLang]}</p>
                            ${shop.longDescription && shop.longDescription[currentLang] ? `<p class="text-gray-700 mb-6">${shop.longDescription[currentLang]}</p>` : ''}
                            
                            ${shop.sustainability && shop.sustainability[currentLang] ? `
                            <h2 class="text-2xl font-bold mb-4" data-i18n-dynamic="modalSustainability"><span class="math-inline">\{translations\[currentLang\]\.modalSustainability\}</h2\>
<div class\="mb\-6"\>
<p class\="text\-gray\-700 mb\-4"\></span>{shop.sustainability[currentLang]}</p>
                                ${shop.tags && shop.tags[currentLang] && shop.tags[currentLang].length > 0 ? `
                                <div class="flex flex-wrap gap-2 mb-4">
                                    ${shop.tags[currentLang].map(tag => `<span class="tag px-3 py-1 rounded-full text-sm">${tag}</span>`).join('')}
                                </div>
                                `
